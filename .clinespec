# Backlog コメントリンク生成拡張機能 仕様書
## 目的

Backlogのチケット画面において、コメントの日時部分を右クリックすることで、そのコメントへのマークダウン形式のリンクをクリップボードにコピーする Chrome 拡張機能を作成します。

## 動作環境

- Google Chrome (Manifest V3対応版)
- Backlogのチケット詳細ページ（`https://*.backlog.jp/view/*`）

## 機能要件

### 基本機能

1. Backlogのチケット詳細ページでのみ動作する
2. コメントの日時部分（リンク要素）を右クリックした際に、コンテキストメニューに専用項目を表示する
3. コンテキストメニュー項目をクリックすると、マークダウン形式のリンクをクリップボードにコピーする
4. コピー成功時に画面上に通知を表示する
5. 設定画面を提供し、セレクタやドメイン、通知設定をカスタマイズ可能にする

### 生成するマークダウンリンクの形式

```
[[プロジェクトID-チケット番号]] [コメント日時](https://サブドメイン.backlog.jp/view/プロジェクトID-チケット番号#comment-コメントID)
```

例：
```
[[PROJ-123]] [2025/03/07 09:55:14](https://example.backlog.jp/view/PROJ-123#comment-266455529)
```

### データ抽出要件

以下の情報を自動的に抽出する必要があります：

1. **プロジェクトID-チケット番号**：現在表示中のURLから抽出
   - 例：`https://example.backlog.jp/view/PROJ-123` から `PROJ-123` を抽出

2. **コメント日時**：右クリックしたリンク要素のテキストコンテンツから取得
   - 例：`2025/03/07 09:55:14`

3. **コメントID**：リンク要素の `href` 属性から抽出
   - 例：`#comment-266455529` から `266455529` を抽出

## 技術仕様

### 必要なファイル

1. `manifest.json` - 拡張機能の設定ファイル
2. `background.js` - バックグラウンドスクリプト（コンテキストメニュー作成とイベント処理）
3. `options.html` - 設定画面のHTML
4. `options.js` - 設定画面のスクリプト
5. アイコン画像（16px, 48px, 128px サイズ）

### 必要な権限

- `contextMenus` - コンテキストメニューの作成
- `activeTab` - 現在のタブでスクリプトを実行
- `scripting` - ページ内スクリプトの実行
- `clipboardWrite` - クリップボードへの書き込み
- `storage` - 設定の保存と読み込み

### マニフェスト設定（V3）

```json
{
  "name": "Backlog Comment Link Copier",
  "description": "Backlogのコメントリンクをマークダウン形式でコピー",
  "version": "1.0",
  "manifest_version": 3,
  "permissions": [
    "contextMenus",
    "activeTab",
    "scripting",
    "clipboardWrite",
    "storage"
  ],
  "host_permissions": [
    "https://*.backlog.jp/*"
  ],
  "background": {
    "service_worker": "background.js"
  },
  "action": {
    "default_popup": "options.html",
    "default_icon": {
      "16": "images/icon16.png",
      "48": "images/icon48.png",
      "128": "images/icon128.png"
    }
  },
  "options_page": "options.html",
  "icons": {
    "16": "images/icon16.png",
    "48": "images/icon48.png",
    "128": "images/icon128.png"
  }
}
```

### コンテキストメニュー要件

- リンク要素を右クリックした場合のみ表示
- `https://*.backlog.jp/view/*` のURLパターンに一致する場合のみ表示
- メニュー項目のタイトル：「コメントリンクをMarkdownでコピー」

### HTMLセレクタ情報

コメント日時要素の特定に使用するセレクタ:
```
.user-icon-set__sub-line a.user-icon-set__sub-line-anchor
```

コメント日時要素の典型的なHTML:
```html
<span class="user-icon-set__sub-line"><a href="#comment-266455529" class="user-icon-set__sub-line-anchor">2025/03/07 09:55:14</a></span>
```

## エラーハンドリング

1. チケットIDが見つからない場合のエラーメッセージ：
   - 「チケットIDが見つかりませんでした。Backlogのチケット画面で実行してください。」

2. コメントIDが見つからない場合のエラーメッセージ：
   - 「コメントリンクが見つかりませんでした。コメントの日時部分を右クリックしてください。」

3. クリップボードへのコピーに失敗した場合のエラーメッセージ：
   - 「クリップボードへのコピーに失敗しました。」

## ユーザーインターフェース

### コピー成功通知

- 位置：画面右上
- 背景色：緑（`#4caf50`）
- テキスト色：白
- 表示時間：3秒
- 表示メッセージ：「コメントリンクをコピーしました」
- 消える際のアニメーション：フェードアウト（0.5秒）

## 使用フロー

1. Backlogのチケット詳細ページを開く
2. コメントセクションの日時部分（リンク）を右クリック
3. コンテキストメニューから「コメントリンクをMarkdownでコピー」を選択
4. マークダウン形式のリンクがクリップボードにコピーされる
5. 画面右上に成功通知が表示される

## 実装上の注意点

- Backlogの画面構造が変更された場合、セレクタの調整が必要になる可能性がある
- 複数のコメントリンクが同一ページに存在する場合でも、右クリックしたリンク要素だけを正確に特定する必要がある
